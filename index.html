<!DOCTYPE html>
<html>
<head>
  <style>
    body {
      margin: 0;
    }
  </style>
  <script src="https://unpkg.com/3d-force-graph"></script>

  <script src="https://cdn.jsdelivr.net/npm/lil-gui@0.19"></script>
  <script>
    var GUI = lil.GUI;
  </script>

  <!--<script src="../../dist/3d-force-graph.js"></script>-->
</head>
<body>
  <div id="3d-graph"></div>
  <script type="importmap">{ "imports": { "three": "https://unpkg.com/three/build/three.module.js" }}</script>
  <script type="module">
    import SpriteText from "https://unpkg.com/three-spritetext/dist/three-spritetext.mjs";
    import { UnrealBloomPass } from 'https://unpkg.com/three/examples/jsm/postprocessing/UnrealBloomPass.js';
    import * as THREE from 'three';

    const distance = 1400;

    const Graph = new ForceGraph3D({ controlType: 'orbit' })
      (document.getElementById('3d-graph'))
      .backgroundColor('#000003')
      .jsonUrl('graph.json') // Choose the appropriate JSON URL for your data
      .showNavInfo(false)
      .cameraPosition({ z: distance })
      .nodeAutoColorBy('group')
      .nodeThreeObject(node => {
        // Node customization with sprite text
        const sphereGeometry = new THREE.SphereGeometry(20);
        const sphereMaterial = new THREE.MeshBasicMaterial({
          color: 'light grey',
          transparent: true,
          opacity: 0.4
        });
        const sphereMesh = new THREE.Mesh(sphereGeometry, sphereMaterial);

        // Create a new Object3D to hold the sphere mesh and sprite text
        const container = new THREE.Object3D();
        container.add(sphereMesh);

        const sprite = new SpriteText(node.id);
        sprite.material.depthWrite = false; // make sprite background transparent
        sprite.color = 'lightgrey';
        sprite.textHeight = 10;

        // Set the position of the sprite text to be in front of the sphere mesh
        sprite.position.set(0, 0, sphereGeometry.parameters.radius + 2);

        // Add the sprite text to the container
        container.add(sprite);

        return container;
      })
      .nodeLabel('id') // Assuming you want to keep the node labels as in the second script
      .linkThreeObjectExtend(true)
      .linkThreeObject(link => {
        // Extend link with text sprite showing the relationship
        const sprite = new SpriteText(`${link.source} > ${link.target}`);
        sprite.color = 'lightgrey';
        sprite.textHeight = 3;
        return sprite;
      })
      .linkPositionUpdate((sprite, { start, end }) => {
        // Positioning the sprite at the middle of the link
        const middlePos = Object.assign(...['x', 'y', 'z'].map(c => ({
          [c]: start[c] + (end[c] - start[c]) / 3 // calculate middle point
        })));
        Object.assign(sprite.position, middlePos);
      })
      // Adjust the force to spread nodes a little wider
      .d3Force('charge').strength(-500);

    // Camera orbit
    let angle = 0;
    setInterval(() => {
      const x = distance * Math.sin(angle);
      const z = distance * Math.cos(angle);
      Graph.cameraPosition({ x, z }, { x: 0, y: 0, z: 0 });
      angle += Math.PI / 300;
    }, 10);


    // Create a GUI
    const gui = new GUI();
    gui.add( document, 'title' );

    const settings = {
      forceStrength: -500
    };

    // Add a slider to control the force strength
    gui.add(settings, 'forceStrength', -1000, 0).onChange(value => {
      Graph.d3Force('charge').strength(value);
      Graph.numDimensions(100); // Update the graph dimensions to trigger a re-render
    });

    const bloomPass = new UnrealBloomPass();
    bloomPass.strength = 5;
    bloomPass.radius = 2;
    bloomPass.threshold = 0.1;
    Graph.postProcessingComposer().addPass(bloomPass);

    // Add bloom pass controls
    const bloomFolder = gui.addFolder('Bloom Pass');
    bloomFolder.add(bloomPass, 'strength', 0, 10).step(0.1);
    bloomFolder.add(bloomPass, 'radius', 0, 5).step(0.1);
    bloomFolder.add(bloomPass, 'threshold', 0, 1).step(0.01);
    bloomFolder.open();


  </script>
</body>
</html>
